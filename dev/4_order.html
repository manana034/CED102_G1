@@include("./layout/B_head.html");
<title>Order</title>

</head>
<body>
    <!-- 側邊欄 -->
    @@include('./layout/B_aside.html')
    <!-- 右邊主欄 -->
    <div class="main" id="app">  
        <div class="main_top">
            <div class="search_bar">
                <div class="search-input">
                    <input type="search" placeholder="Enter No. Or Member">
                    <button>
                        <img src="./icon/magnifier_white.png">
                    </button>  
                </div>
                <div class="custom-select">
                    <select name="sType">
                        <option value="0">All</option>
                        <option value="0">All</option>
                        <option value="1">Paid</option>
                        <option value="2">Shipped</option>
                        <option value="3">Cancelled</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="main_bottom">
            <table>
                <tr>
                    <th>no</th>
                    <th>member</th>
                    <th>points</th>
                    <th>total</th>
                    <th>recipient</th>
                    <th>phone</th>
                    <th>address</th>
                    <th>order time</th>
                    <th>state</th>
                    <th>detail</th>
                </tr>
                <tr v-for="(order,index) in orders" :data-no="index+1">
                    <td>{{order.orderNo}}</td>
                    <td>{{order.mNo}}</td>
                    <td>{{order.usePoints}}</td>
                    <td>{{order.total}}</td>
                    <td>{{order.orderer}}</td>
                    <td>{{order.tel}}</td>
                    <td>{{order.address}}</td>
                    <td>{{order.orderDate}}</td>
                    <td>
                        <select class="Type" name="Type" @change.stop="insertData" :value="order.orderState">
                            <option value="1">Paid</option>
                            <option value="2">Shipped</option>
                            <option value="3">Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button class="detail l-btn" @click="detail(index)">Detail</button>
                    </td>
                </tr>
                <!-- <tr>
                    <td>20</td>
                    <td>5</td>
                    <td>0</td>
                    <td>$13500</td>
                    <td>買很多</td>
                    <td>0922333444</td>
                    <td>桃園市中壢區興安一街111號</td>
                    <td>2021-04-01 23:11</td>
                    <td>
                        <select class="Type" name="Type">
                            <option value="1">Paid</option>
                            <option value="2">Shipped</option>
                            <option value="3">Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button class="detail l-btn">Detail</button>
                    </td>
                </tr> -->
            </table>
        </div>
    <!-- 訂單明細的燈箱 -->
        <div class="lightbox_orderDetail_black">
            <div class="lightbox">
                <div class="close">
                    <img class="close" src="./icon/close.svg">
                </div>
                <div>Order No.<span>{{index+1}}</span>  Order Detail</div>
                <table>
                    <tr>
                        <th>Product No</th>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                    </tr>
                    <tr v-for="order in list">
                        <td>{{order.prodNo}}</td>
                        <td>{{order.fdName}}</td>
                        <td>{{order.quantity}}</td>
                        <td>${{order.price}}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

<script>
    let vm = new Vue({
                el: "#app",
                data: {
                    orders:[],
                    list:[],
                    index: 0,
                },
                methods:{
                    insertData(e){
                        console.log('wrok')
                        let url = `./php/changeState.php?state=${e.target.value}&No=${e.target.parentNode.parentNode.dataset.no}`
                        fetch(url)
                        .then(res => res.text())
                        .then(res => {
                            console.log(res)
                        })
                            // .catch(error => console.log(error))
                            // .then(body => console.log(body))
                    },
                        // 訂單明細的 lightbox
                    detail(index){
                            vThis = this;
                            this.list = [];
                            this.index = index ;
                            function fetch(){
                                let xhr = new XMLHttpRequest()
                                xhr.open('get', './php/4_adminOrderlist.php', true)

                                xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded')
                                xhr.send(null)
                                xhr.onload = function(){
                                    let orderlist = JSON.parse(xhr.responseText);
                                    // vThis.list = orderlist ;
                                    for(let i = 0 ; i < orderlist.length ; i++){
                                        if(orderlist[i].orderNo == index+1){
                                            arr.push(orderlist[i])
                                        }
                                        arr = vThis.list
                                    }
                                    vThis.list[0].index = index;
                                    console.log(index);
                                }
                            }

                            fetch()
                            
                            $('.lightbox_orderDetail_black').css('display','block');
                            $('.lightbox>div>img.close').click(function(){
                                $('.lightbox_orderDetail_black').css('display','none');
                            });
                    }
                }
            });

    fetch(`./php/4_adminOrder.php`).then(res => res.json())
                        .then(data =>{
                            vm.orders = data
                            console.log(data);
                        })
    </script>
</body>
</html>