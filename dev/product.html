<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./css/common/product.css">
    <link rel="icon" href="../img/logo.ico" type="image/x-icon">
    <script src="./js/header.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.min.js"></script>    
    <title>Product</title>
</head>
<body>
    <div class="headerContainer">
        @@include('./layout/header.html')
        @@include('./layout/cart.html')
    </div>  

    <div class="prodContent" id="prodContent">
        <div class="prod_desc">
            <h5> {{prod.fdName}} </h5>
            <p>{{prod.fdCalPer}} Cal / per</p>
            <p v-html="prod.des"></p>
            <!-- <p> The calories you consume of the meal gets 50% discount.<p>
            <p> Ingredients
                dark chocolate (49%)<br>
                (cacao mass, coconut sugar,cacao butter),<br>
                roasted almonds (49%),
                cocoa powder, salt.for allergens,
                including cereals containing gluten,
                see ingredients in bold.</p> -->
        </div>
        <div class="productDetail">
            <div v-if="prod.calRate > 1" style="backgroundColor:#bf4659" class="prodimg">
                <img :src="prod.prodpic1">
            </div>
            <div v-else-if="prod.calRate < 1" style="backgroundColor:#2d6ca6" class="prodimg">
                <img :src="prod.prodpic1">
            </div>
            <div v-else-if="prod.calRate = 1" style="backgroundColor:#f9c530" class="prodimg">
                <img :src="prod.prodpic1">
            </div>
            <div class="prod1Info">
                <p>NT${{prod.price}}</p>
                <form>
                    <label for="quantity">QUANTITY : </label>
                    <div class="btn_number">
                        <span class="btn_minus"> &minus; </span>
                        <input type="number" name="quantity" id="quantity" value="1" min="1" max="10">
                        <span class="btn_add">  &plus; </span>
                    </div>                    
                </form>
                <button class="byn" @click="cart">ADD TO CART</button>
                <!-- <button class="wishlist"> WISH LIST</button> -->
            </div>
        </div>
        <div class="prod_infoall">
            <h6>ENJOY IT!</h6>
            <p>Vegan friendly. High in fibre. Store in a cool, dry place.<br>
            We’re so excited to have a brand new look. We don’t want to send our previous packaging to waste so your order might contain both old and new pack designs whilst we’re making this switch</p>
            <div class="prod1_pic">
                <img :src="prod.prodpic2">
                <img :src="prod.prodpic3">
            </div>
        </div>
       
    </div>

    <h6>MORE FITNESS?</h6>  
    @@include('./layout/moreproduct.html')
    
    @@include('./layout/footer.html')
    <script>
    //buy now to cart
    // const buynow = document.querySelectorAll(".byn");

    // buynow.forEach(byn =>{
    //     byn.addEventListener("click",function(){
    //         cart.classList.add("opencart");
    //     })
    // })

    let vm = new Vue({
        el:"#prodContent",
        data:{
            prod:[],
            
        },
        methods: {
          cart(e){
            const displayArea = document.querySelector('.prod');
                        const vthis = this;
                        const cart = document.querySelector(".cart");
                        cart.classList.add("opencart");
                        let localProduct = JSON.parse(localStorage.getItem("localProduct")) || [];
                        function display(){
            
                            function update(){
                                localStorage.setItem('localProduct', JSON.stringify(localProduct));
                            }
                            //在購物車創造元素
                            function displayProduct(product){
                                displayArea.innerHTML += `
                                                        <li class="prodcart" data-no="${product.no}">
                                                        <p>${product.name}</p>
                                                        <div class="cartimg">
                                                            <img src="${product.src}"> 
                                                        </div>
                                                        <img class="trash" src="./img/trash.png">
                                                        <div class="qty">
                                                            <form>
                                                                <label for="quantity">QUANTITY : </label>
                                                                <div class="btn_number">
                                                                    <span class="btn_minus"> &minus; </span>
                                                                    <input type="number" value="${product.value}" min="1" max="10" class="quantity">
                                                                    <span class="btn_add">  &plus; </span>
                                                                </div>                    
                                                            </form> 
                                                            <p>NT$${product.price}</p>
                                                            </div>
                                                            </li>  
                                                            `;
                                                        }
                            //更新localStorage資料
                            function update(){
                                localStorage.setItem('localProduct', JSON.stringify(localProduct));
                            }
                            //加入購物車的商品資料
                            console.log(e.target.parentNode.children[1].children[1].children[1].value);
                            let product = {
                                name: vthis.prod.fdName,
                                price : vthis.prod.price,
                                src : vthis.prod.prodpic1,
                                value: e.target.parentNode.children[1].children[1].children[1].value,
                                no : parseInt(vthis.prod.prodNo),
                            }

                            //判斷是否為加入過的商品
                            if(localProduct.length === 0){
                                localProduct.push(product)
                                displayProduct(product)
                            }else{
                                for(let i=0 ; i<localProduct.length ; i++){
                                    if(localProduct[i].no === product.no){
                                        // return 
                                        // alert("已加入過購物車")
                                        localProduct[i].value++;
                                        displayArea.children[i].children[3].children[0].children[1].children[1].value = localProduct[i].value
                                    }else if(localProduct[localProduct.length-1].no !== product.no){
                                        localProduct.push(product)
                                        displayProduct(product)
                                        // console.log("object");
                                    }
                                }
                            }
                            update(product)
                        }
                        display()

                    const btn_add = document.querySelectorAll(".btn_add");
                    const btn_minus =document.querySelectorAll(".btn_minus");
                    const quantity = document.querySelectorAll(".quantity");
                    //按加號
                    btn_add.forEach((add,index) => add.addEventListener("click",function(){
                        quantity[index].stepUp(1);
                        localProduct[index].value = quantity[index].value;
                        quantity[index].setAttribute('value',localProduct[index].value);
                        localStorage.setItem('localProduct', JSON.stringify(localProduct));
                        total()
                    }));
                    //按減號
                    btn_minus.forEach((minus,index) => minus.addEventListener("click",function(){
                        quantity[index].stepDown(1);
                        localProduct[index].value = quantity[index].value;
                        quantity[index].setAttribute('value',localProduct[index].value);
                        localStorage.setItem('localProduct', JSON.stringify(localProduct));
                        total()
                    }));
                    //點按 X 刪除鍵
                    displayArea.addEventListener('click', event =>{
                        if(event.target.className !== 'trash') {return}
                        const li = event.target.parentElement
                        console.log(li);
                        li.remove(); //刪除畫面裡購物車的東西

                        //刪除localStorage裡的東西
                        for(let i = 0; i <localProduct.length; i++){
                            if(li.dataset.no == localProduct[i].no){
                                // console.log("object");
                                localProduct.splice(i,1);
                                break;
                            }
                        }
                        //更新localStorage
                        total();
                        localStorage.setItem('localProduct', JSON.stringify(localProduct));

                    });
                    //total
                    function total(){
                        let subtotal = 0;
                        const total = document.querySelector(".allprice p span");
                        for(let i =0; i<localProduct.length ; i++){
                            let item = localProduct[i];
                            subtotal += (item.price * item.value);
                        }
                        total.innerText = subtotal;
                    }
                    total()
          },
        },
        mounted() {
            // console.log('work')
            //資料庫
            const sessionId = sessionStorage.getItem("no");
            // console.log(sessionId)
            let xhr = new XMLHttpRequest()
            xhr.onload = function(){
                console.log('在這裡抓回資料')
                vm.prod = JSON.parse(xhr.responseText);
                // console.log(JSON.parse(xhr.responseText))
                // console.log(xhr.responseText)
                // console.log(vm)
            }
            xhr.open('GET',`php/getProduct.php?pNo=${sessionId}`)
            xhr.send(null)
        },
    });
    console.log(vm.prod);


    //   fetch(`./php/getProduct.php`).then(res => res.json())
    //                                 .then(data => {
    //                                     // console.log(data);
    //                                     data.forEach(d => {
    //                                         if(d.prodNo === sessionId){
    //                                             vm.prod = d;
    //                                             // console.log(vm.prod);
    //                                         }
    //                                     })
    //                                     // vm.prod = data;                                 
    //                                 });
    //                                                 // console.log(vm.prod);
    //                                                 // console.log(vm.prod);
    //                                                 // console.log(vm1.prods);
    </script>

    
     
    <script src="./js/cart.js"></script>
    <script src="./js/quantity.js"></script>
    <script src="./js/header_customSelect.js" defer></script>
</body>
</html>